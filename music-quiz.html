<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiplayer Music Quiz Game</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <!-- Fixed CDN URL for Socket.IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
</head>
<body data-font-size="normal">
<div class="container">
  <div class="header">
    <h1>ğŸµ Multiplayer Music Quiz</h1>
    <p>Play music quiz games with friends online!</p>

    <!-- Font Size Controls -->
    <div class="font-controls">
      <span style="color: rgba(255,255,255,0.9); margin-right: 10px;">ğŸ“º View Size:</span>
      <button class="btn btn-font" onclick="setFontSize('small')" title="Normal Size">A</button>
      <button class="btn btn-font" onclick="setFontSize('normal')" title="Large Size">A+</button>
      <button class="btn btn-font" onclick="setFontSize('large')" title="Extra Large">A++</button>
      <button class="btn btn-font" onclick="setFontSize('xlarge')" title="TV Mode">ğŸ“º</button>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-buttons">
    <button class="btn" onclick="showPanel('home')">ğŸ  Home</button>
    <button class="btn btn-secondary" onclick="showPanel('create')">ğŸ® Create Game</button>
    <button class="btn btn-secondary" onclick="showPanel('join')">ğŸšª Join Game</button>
    <button class="btn btn-secondary" onclick="leaveGame()" id="leave-btn" style="display: none; background: #f44336;">ğŸšª Leave Game</button>
    <button class="btn btn-small" onclick="emergencyReset()" style="background: #ff5722; font-size: 12px; padding: 6px 12px;">ğŸš¨ Reset</button>
  </div>

  <!-- Game Status Bar -->
  <div id="game-status" class="game-status-bar hidden">
    <div class="status-info">
      <span id="connection-status">ğŸ”´ Offline</span>
      <span id="game-id-display">Game ID: </span>
      <span id="player-role">Role: </span>
      <span id="player-count">Players: </span>
    </div>
    <button class="btn btn-small" onclick="copyGameId()" id="share-btn">ğŸ“‹ Share Game ID</button>
  </div>

  <!-- Home Panel -->
  <div id="home-panel" class="panel">
    <h2>Welcome to Multiplayer Music Quiz! ğŸ‰</h2>
    <p style="margin: 20px 0; font-size: 1.1rem; line-height: 1.6;">
      Create a music quiz game with your own collection and invite friends to play!
      The host loads the music and controls the game, while all players can guess the songs
      and compete for the highest score.
    </p>

    <div class="multiplayer-options">
      <div class="option-card">
        <h3>ğŸ® Host a Game</h3>
        <p>Load your music collection and create a game for others to join.</p>
        <button class="btn" onclick="showPanel('create')">Create Game</button>
      </div>
      <div class="option-card">
        <h3>ğŸšª Join a Game</h3>
        <p>Enter a game ID to join an existing music quiz game.</p>
        <button class="btn btn-secondary" onclick="showPanel('join')">Join Game</button>
      </div>
    </div>

    <div class="server-info">
      <h3>ğŸŒ Multiplayer Status</h3>
      <div class="connection-test">
        <div class="status-display">
          <span id="detailed-connection-status">ğŸ”´ Not connected to server</span>
          <button class="btn btn-small" onclick="testConnection()" id="test-connection-btn">ğŸ”§ Test Connection</button>
        </div>
        <div id="connection-help" style="display: none; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 5px; border: 1px solid #f44336;">
          <p><strong>âš ï¸ No server connection detected!</strong></p>
          <p>For multiplayer games, you need to run the Socket.IO server.</p>
        </div>
      </div>

      <details style="margin-top: 15px;">
        <summary style="cursor: pointer; color: #667eea; font-weight: bold;">ğŸ“‹ Quick Server Setup Instructions</summary>
        <div style="background: #f8f9fa; padding: 15px; margin-top: 10px; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
          <p><strong>1. Install Node.js and create a new folder:</strong></p>
          <code>mkdir music-quiz-server && cd music-quiz-server</code><br><br>

          <p><strong>2. Initialize and install dependencies:</strong></p>
          <code>npm init -y<br>npm install socket.io express cors</code><br><br>

          <p><strong>3. Create server.js with the provided server code</strong></p>
          <p><strong>4. Run the server:</strong></p>
          <code>node server.js</code><br><br>

          <p><strong>5. You should see: "ğŸµ Music Quiz Server running on port 3001"</strong></p>
          <p style="color: #666; margin-top: 10px;"><em>Without a server, games work in offline mode (single device only)</em></p>
        </div>
      </details>
    </div>

    <div class="recent-games" id="recent-games" style="display: none;">
      <h3>ğŸ•’ Recent Games</h3>
      <div id="recent-games-list"></div>
    </div>
  </div>

  <!-- Create Game Panel -->
  <div id="create-panel" class="panel hidden">
    <h2>ğŸ® Create Multiplayer Game</h2>

    <!-- Player Setup -->
    <div class="player-setup">
      <div class="form-group">
        <label for="host-name">Your Name:</label>
        <input type="text" id="host-name" placeholder="Enter your name..." maxlength="20">
      </div>
    </div>

    <!-- Upload Section -->
    <div id="music-upload-section" class="music-section">
      <h3>ğŸ“ Load Your Music Collection</h3>
      <div class="upload-area">
        <input type="file" id="music-folder" webkitdirectory directory multiple style="display: none;" onchange="loadMusicFolder(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('music-folder').click()">
          ğŸ“‚ Select Music Folder
        </button>
        <p class="upload-info">Select a folder containing your MP3 files<br>
          <small>ğŸ’¡ This will load all MP3 files from the selected folder and subfolders</small></p>

        <!-- Fallback for manual file selection -->
        <div class="fallback-section">
          <hr style="margin: 20px 0;">
          <p style="color: #666; font-size: 0.9rem;">Alternative: Select multiple files manually</p>
          <input type="file" id="music-files-manual" multiple accept=".mp3,audio/mpeg" style="display: none;" onchange="loadMusicFiles(event)">
          <button class="btn btn-secondary btn-small" onclick="document.getElementById('music-files-manual').click()">
            ğŸ“„ Select Individual Files
          </button>
        </div>

        <div id="music-file-list" class="file-list"></div>
      </div>
    </div>

    <!-- Game Settings -->
    <div id="music-settings-section" class="music-section hidden">
      <h3>âš™ï¸ Game Settings</h3>
      <div class="settings-grid">
        <div class="form-group">
          <label for="songs-count">Number of Songs:</label>
          <select id="songs-count">
            <option value="5">5 Songs</option>
            <option value="10" selected>10 Songs</option>
            <option value="15">15 Songs</option>
            <option value="20">20 Songs</option>
            <option value="25">25 Songs</option>
          </select>
        </div>
        <div class="form-group">
          <label for="clip-duration">Clip Duration:</label>
          <select id="clip-duration">
            <option value="15">15 seconds</option>
            <option value="20" selected>20 seconds</option>
            <option value="30">30 seconds</option>
            <option value="45">45 seconds</option>
          </select>
        </div>
        <div class="form-group">
          <label for="max-players">Max Players:</label>
          <select id="max-players">
            <option value="2">2 Players</option>
            <option value="4" selected>4 Players</option>
            <option value="6">6 Players</option>
            <option value="8">8 Players</option>
            <option value="10">10 Players</option>
          </select>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="autoplay-next" checked>
            <span class="checkmark"></span>
            ğŸµ Autoplay Next Song
          </label>
          <small class="setting-description">Automatically advance to next song when clip ends</small>
        </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn" onclick="createGame()">ğŸ® Create Game & Get ID</button>
        <button class="btn btn-secondary" onclick="showPanel('home')" style="margin-left: 15px;">ğŸ  Back to Home</button>
      </div>
    </div>
  </div>

  <!-- Join Game Panel -->
  <div id="join-panel" class="panel hidden">
    <h2>ğŸšª Join Game</h2>

    <div class="join-form">
      <div class="form-group">
        <label for="player-name">Your Name:</label>
        <input type="text" id="player-name" placeholder="Enter your name..." maxlength="20">
      </div>

      <div class="form-group">
        <label for="game-id-input">Game ID:</label>
        <input type="text" id="game-id-input" placeholder="Enter the 6-digit game ID..." maxlength="6" style="text-transform: uppercase;">
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <button class="btn" onclick="joinGame()">ğŸšª Join Game</button>
        <button class="btn btn-secondary" onclick="showPanel('home')" style="margin-left: 15px;">ğŸ  Back to Home</button>
      </div>
    </div>
  </div>

  <!-- Lobby Panel -->
  <div id="lobby-panel" class="panel hidden">
    <h2>ğŸµ Game Lobby</h2>

    <div class="lobby-info">
      <div class="game-details">
        <h3 id="lobby-game-id">Game ID: ABC123</h3>
        <p id="lobby-settings">Settings: 10 songs, 20 seconds each</p>
      </div>

      <div class="players-list">
        <h3>ğŸ‘¥ Players (<span id="current-player-count">1</span>/<span id="max-player-count">4</span>)</h3>
        <div id="players-container"></div>
      </div>
    </div>

    <div class="lobby-actions" id="host-controls" style="display: none;">
      <button class="btn" onclick="startMultiplayerGame()" id="start-game-btn">ğŸš€ Start Game</button>
      <button class="btn btn-secondary" onclick="leaveGame()" style="margin-left: 15px;">ğŸšª Leave Game</button>
    </div>

    <div class="lobby-actions" id="player-controls" style="display: none;">
      <p style="text-align: center; color: #666; margin: 20px 0;">Waiting for host to start the game...</p>
      <button class="btn btn-secondary" onclick="leaveGame()">ğŸšª Leave Game</button>
    </div>
  </div>

  <!-- Game Panel -->
  <div id="game-panel" class="panel hidden">
    <div class="game-header">
      <div class="question-counter">
        Song <span id="current-song-num">1</span> of <span id="total-songs">10</span>
      </div>
      <div class="player-scores" id="scores-button-container" style="display: none;">
        <button class="btn btn-small" onclick="toggleScoreboard()">ğŸ“Š Scores</button>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="music-progress-fill"></div>
    </div>

    <!-- Host Controls (Music Player) -->
    <div class="music-player" id="host-music-player" style="display: none;">
      <div class="song-info">
        <h3>ğŸµ Playing song for all players</h3>
        <div class="audio-controls">
          <audio id="music-audio" controls></audio>
          <div class="playback-timer">
            <span id="audio-timer">0:00 / 0:20</span>
          </div>
        </div>
      </div>

      <div class="host-controls-game">
        <button class="btn btn-secondary" onclick="replayClip()">ğŸ”„ Replay</button>
        <button class="btn btn-secondary" onclick="skipSong()">â­ï¸ Next Song</button>
        <button class="btn" onclick="showAnswers()">ğŸ‘ï¸ Show Answers</button>
      </div>
    </div>

    <!-- Non-Host Music Player -->
    <div class="music-player" id="non-host-music-player" style="display: none;">
      <div class="song-info">
        <h3>ğŸµ Waiting for the host to start the song...</h3>
        <div class="audio-controls">
          <audio id="non-host-audio" controls></audio>
          <div class="playback-timer">
            <span id="non-host-audio-timer">0:00 / 0:20</span>
          </div>
        </div>
      </div>

    <!-- Player Input -->
    <div class="guess-section">
      <div class="form-group">
        <label for="song-guess">Your Guess:</label>
        <input type="text" id="song-guess" placeholder="Enter song title, artist, or album..." maxlength="100">
      </div>

      <div class="music-controls">
        <button class="btn" onclick="submitGuess()">âœ… Submit Guess</button>
        <button class="btn btn-secondary" onclick="skipPersonalGuess()" style="margin-left: 10px;">â­ï¸ Skip</button>
      </div>
    </div>

    <!-- Live Updates -->
    <div class="live-updates">
      <h4>ğŸ”´ Live Updates</h4>
      <div id="live-feed"></div>
    </div>
  </div>

  <!-- Results Panel -->
  <div id="results-panel" class="panel hidden">
    <h2>ğŸ† Final Results</h2>

    <div class="final-leaderboard">
      <h3>ğŸ† Final Leaderboard</h3>
      <div id="final-leaderboard"></div>
    </div>

    <div class="detailed-results">
      <h3>ğŸ“Š Detailed Results</h3>
      <div id="detailed-results-container"></div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <button class="btn quick-play" onclick="playAgain()" id="play-again-btn" style="margin-right: 10px;">ğŸµ Play Again</button>
      <button class="btn btn-secondary" onclick="leaveGame()" style="margin-right: 10px;">ğŸšª Leave Game</button>
      <button class="btn btn-secondary" onclick="showPanel('home')">ğŸ  Home</button>
    </div>
  </div>

  <!-- Scoreboard Modal -->
  <div id="scoreboard-modal" class="modal hidden" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“Š Live Scoreboard</h3>
        <button class="modal-close" onclick="closeScoreboard()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="live-scoreboard"></div>
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 15px;">
          ğŸ’¡ Click outside, press ESC, or click Ã— to close
        </p>
        <div style="text-align: center; margin-top: 10px;">
          <button class="btn btn-small btn-secondary" onclick="closeScoreboard()">Close Scoreboard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notification system -->
<div id="notification" class="notification"></div>

<!-- Test script to verify Socket.IO is loading -->
<script>
  // Test if Socket.IO loaded successfully
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      if (typeof io !== 'undefined') {
        console.log('âœ… Socket.IO loaded successfully!');
      } else {
        console.error('âŒ Socket.IO failed to load');
        alert('Socket.IO library failed to load. Check the console for more details.');
      }
    }, 1000);
  });
</script>

<script src="socket.js"></script>
</body>
</html>
